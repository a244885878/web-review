> `Vue.set()` 和 `this.$set()` 方法主要用于向响应式对象中添加属性，并确保新属性也是响应式的，从而触发视图更新。这是因为 Vue 的响应式系统在初始化时会通过 `Object.defineProperty` 遍历 `data` 中的属性，将其转换为 getter/setter，从而追踪变化。但对于动态添加的属性，`Vue` 无法在初始化时进行追踪，因此需要使用 `$set` 方法。

#### 实现原理:

`Vue.set()` 和 `this.$set()` 的实现原理基本一致，最终都调用了 `set` 函数。这个 `set` 函数位于 `../observer/index` 文件中。区别在于：

- `Vue.set()` 将 `set` 函数绑定在 `Vue` 构造函数上。
- `this.$set()` 将 `set` 函数绑定在 `Vue` 原型上。

`set` 函数接收三个参数：

- `target`: 要操作的对象或数组。
- `key`: 要添加或修改的属性名或数组索引。
- `val`: 要设置的值。

其内部实现逻辑大致如下：

1. 参数校验: 首先会检查 `target` 是否为 `undefined`、`null` 或基本数据类型，如果是则直接报错。
2. 数组处理: 如果 `target` 是数组，并且 `key` 是一个有效的索引，则使用 `splice` 方法插入或替换元素。`splice` 方法本身会触发数组的响应式更新。
3. 对象处理: 如果 `target` 是对象，则进行以下判断：
   - 如果 `key` 已经存在于 `target` 中，则直接赋值，这会触发已有属性的 `setter`，从而触发更新。
   - 如果 `key` 不存在于 `target` 中，则使用 `Object.defineProperty` 将新属性添加到 `target` 上，并将其转换为 `getter/setter`，从而使其具有响应式特性。然后手动触发依赖更新，确保视图能够正确渲染。

#### 为什么要使用 $set？

由于 Vue 的响应式系统是基于 `Object.defineProperty` 实现的，它只能侦测到对象在初始化时就已经存在的属性的变化。对于后面动态添加的属性，Vue 无法侦测到，也就无法触发视图更新。因此，需要使用 `$set` 方法来手动将新属性添加到对象上，并将其转换为响应式属性，从而确保视图能够正确更新。

#### 总结:

`$set` 方法的本质是弥补了 Vue 响应式系统对于动态添加属性的不足。它通过 `splice` (针对数组) 或` Object.defineProperty` (针对对象) 来确保新添加的属性也具有响应式特性，从而触发视图更新。

#### vue3 的$set

在 Vue 3 中，`Vue.set` 和`this.$set` 的使用场景大大减少，但并非完全不需要。理解这一点需要先回顾 Vue 2 中为什么需要 $set。

Vue 3 使用了 `Proxy` 替代 `Object.defineProperty` 作为响应式系统的核心。`Proxy` 可以直接侦测到对象属性的添加和删除，因此在大多数情况下，你不再需要使用 `$set`

何时仍然需要 $set (或类似方法):

虽然 Proxy 覆盖了绝大多数场景，但仍然存在一些特殊情况，你可能需要类似 `$set` 的方法：

1. 向 `Map`、`Set` 等原生集合类型添加属性: `Proxy` 无法直接侦测到 `Map` 和 `Set` 内部的变化。如果你使用 `Map` 或 `Set` 作为响应式数据，并且需要添加新的键值对或元素，你需要使用 `Map.set()` 或 `Set.add()` 等方法，这些方法本身会触发更新。或者，你可以使用 `reactive` 包裹一个普通对象来模拟 `Map` 或 `Set` 的行为。
2. 避免某些极端情况下的性能问题: 在一些非常极端的情况下，例如需要深度监听一个包含大量嵌套对象的复杂数据结构，直接使用 `Proxy` 可能会带来一定的性能开销。这时，你可能需要采用更精细化的响应式控制策略，例如使用 `shallowReactive` 或 `shallowRef`，并结合一些手动更新的技巧。但这种情况非常少见，通常不需要过度关注。

#### 总结:

在绝大多数情况下，`Vue 3` 中你不再需要使用 `$set`。`Proxy` 的强大功能使得动态添加属性变得简单而自然。只有在处理原生集合类型（`Map`、`Set`）或遇到非常特殊的性能瓶颈时，你才可能需要考虑类似 `$set` 的方法。因此，可以认为 `$set` 在 `Vue 3` 中基本已被废弃，除非遇到上述特殊情况。

##### 补充说明:

虽然 `Vue.set` 和 `this.$set` 在 `Vue 3` 中仍然存在（为了兼容 `Vue 2` 的代码），但它们内部的实现已经发生了变化，不再使用 `Object.defineProperty`，而是直接操作 `Proxy`。所以，即使你在 Vue 3 中使用了 `$set`，它本质上也是在利用 `Proxy` 的功能。
