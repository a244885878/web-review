# Koa 框架理解

### 1. 什么是 Koa？

- Koa 是一个基于 Node.js 的极简、灵活的 Web 框架，由 Express 原班人马打造。
- 它被设计用来构建更小、更富表现力和更健壮的 Web 应用和 API。
- 目标是通过使用 async/await（异步函数）来提高开发效率，简化异步流程。

### 2. 核心特点

- 极简核心：**Koa** 本身非常轻量，只有最基础的功能，更多的功能通过中间件实现。
- **中间件机制**：采用洋葱模型（onion model），中间件顺序执行，支持异步，便于错误处理和请求控制。
- **基于 async/await**：官方从 Koa 2 开始，全面支持 async/await，避免了回调地狱，更易读写。
- **无内置路由和中间件**：不像 Express 内置路由和解析中间件，Koa 鼓励使用第三方中间件组合实现所需功能。

### 3. Koa 的核心组成

- **应用对象（app）**：Koa 实例，用于注册中间件，监听端口等。
- **中间件（middleware）**：函数，接收 ctx（上下文）和 next，负责处理请求和响应。
- **上下文对象（ctx）**：封装了 Node.js 的 req 和 res，提供更方便的接口。

### 4. 中间件的执行机制（洋葱模型）

- 中间件按顺序执行，类似洋葱剥皮：

```rust
中间件1: 执行前 -> next -> 中间件2: 执行前 -> next -> 中间件3: 执行 -> 返回后续 -> 中间件2: 执行后 -> 中间件1: 执行后
```

- 这种机制允许在请求处理前后都能执行代码，方便做日志、鉴权、异常捕获等。

### 5. 简单示例

```js
const Koa = require("koa");
const app = new Koa();

// 简单的中间件
app.use(async (ctx, next) => {
  console.log("处理中间件1之前");
  await next(); // 继续执行后续中间件
  console.log("处理中间件1之后");
});

app.use(async (ctx) => {
  ctx.body = "Hello Koa";
});

app.listen(3000);
```

### 6. 使用场景

- 构建 RESTful API
- 需要高度定制的中间件流程
- 需要现代异步语法支持的项目
- 希望控制请求生命周期和错误处理的中大型应用

### 7. Koa 与 Express 的区别

| 特点       | Koa                          | Express                  |
| ---------- | ---------------------------- | ------------------------ |
| 设计理念   | 极简、现代，基于 async/await | 功能齐全，内置路由中间件 |
| 中间件机制 | 洋葱模型，Promise 支持       | 传统回调，中间件链       |
| 内置功能   | 几乎无内置功能，需要自行添加 | 内置路由、中间件、模板等 |
| 上下文对象 | ctx，封装 req 和 res         | req 和 res               |
